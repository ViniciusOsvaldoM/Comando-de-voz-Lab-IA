%Reconhecimento de voz com IA no MATLAB
%Controle de uma l√¢mpada (acender/apagar)
%Uso de t√©cnicas de intelig√™ncia artificial

% Define o diret√≥rio onde os arquivos ser√£o salvos
cd('C:\Users\Familia Guimar√£es\Documents\comandodevoz\bancodedados');

% Captura de √°udio
labels = ["ligar", "desligar"];
for i = 1:5
    for label = labels
        disp(['Fale o comando: ', label]);
        recObj = audiorecorder(44100, 16, 1);       %44100 hz 16 bits 1 canal mono
        recordblocking(recObj, 2);                  %Grava por 2 segundos
        
        audioData = getaudiodata(recObj);           %Extrai os dados da grava√ß√£o
        filename = sprintf('%s_%d.wav', label, i);  
        audiowrite(filename, audioData, 44100);     %Salva o √°udio em um arquivo .wav
    end
end
%---------------------------------------------------------------------------------------
%Reconhecimento de Voz com IA
%Pre-processamento: Espectrogramas
files = dir('*.wav');
for k = 1:length(files)                                     %varre a pasta com audios gravados
    [audioData, fs] = audioread(files(k).name);             %L√™ o arquivo atual na posi√ß√£o K
    [s, f, t] = spectrogram(audioData, 256, 250, 256, fs);  %s: matriz com energia f: vetor de frequ√™ncia t: vetor de tempo
    img = abs(s);                                                       %256: tamanho
    %Matriz com energia de F: vetor de frequencia t:                                                        %da janel
    %vetor tempo 256 tamanho da janela FFT                                                        
    %250 sobreposi√ß√£o entre janelas                                                        
    %Fs: taxa de amostragem                                                        
                                                            
                                                         
    
    % Exibe o espectrograma
    figure;
    imagesc(t, f, img);
    axis xy;
    colormap jet;
    colorbar;
    title(['Espectrograma de: ', files(k).name]);

    % Salva como imagem .png

    img = imresize(img, [227 227]); % tamanho para AlexNet ou similar
    imwrite(mat2gray(img), [files(k).name(1:end-4), '.png']);
end
%-------------------------------------------------------------------------------------------
%%
%Cria√ß√£o do Dataset para treinamento

imds = imageDatastore('*.png', ...
    'IncludeSubfolders', false, ...
    'LabelSource', 'foldernames');

% Alternativamente, use nomes dos arquivos como r√≥tulo:
imds.Labels = categorical(extractBefore({imds.Files}, '_'));


%Treinamento da Rede Neural
net = alexnet;
layers = net.Layers;
layers(end-2) = fullyConnectedLayer(2); % 2 classes
layers(end) = classificationLayer;

options = trainingOptions('adam', ...
    'MaxEpochs', 10, ...
    'MiniBatchSize', 8, ...
    'Plots', 'training-progress');

trainedNet = trainNetwork(imds, layers, options);

% Reconhecimento em tempo Real

recObj = audiorecorder(44100, 16, 1);
disp('Fale agora:');
recordblocking(recObj, 2);
audioData = getaudiodata(recObj);
audiowrite('teste.wav', audioData, 44100);

% Gera espectrograma
[audioData, fs] = audioread('teste.wav');
[s, ~, ~] = spectrogram(audioData, 256, 250, 256, fs);
img = abs(s);
img = imresize(img, [227 227]);
img = mat2gray(img);

% Classifica
label = classify(trainedNet, img);
disp(['Comando reconhecido: ', char(label)]);

if label == "ligar"
    disp('üí° A l√¢mpada foi acesa.');
elseif label == "desligar"
    disp('üí° A l√¢mpada foi apagada.');
end